---
import { defaultEditorValue } from '@components/app/components/slate-handling/editor/markdown-editor'
import MainLayout from '@layouts/main-layout.astro'
import { db } from '@lib/db/db'
import { campaign, thing, thingType, user } from '@lib/db/schema'
import { slateToHtml } from '@lib/utils/slate-text-extractor'
import { and, eq } from 'drizzle-orm'
import type { Descendant } from 'slate'

const { username, campaignSlug, thingSlug } = Astro.params

if (!username || !campaignSlug || !thingSlug) {
  return Astro.redirect('/404')
}

// Fetch user by username
const [userData] = await db
  .select()
  .from(user)
  .where(eq(user.username, username))
  .limit(1)

if (!userData) {
  return Astro.redirect('/404')
}

// Fetch thing, campaign, and verify ownership
const thingCampaignQuery = await db
  .select({
    thing,
    campaign,
    thingType,
  })
  .from(thing)
  .fullJoin(campaign, eq(thing.campaignId, campaign.id))
  .fullJoin(thingType, eq(thing.typeId, thingType.id))
  .where(
    and(
      eq(thing.slug, thingSlug),
      eq(campaign.slug, campaignSlug),
      eq(campaign.userId, userData.id),
      eq(thing.published, true),
      eq(campaign.published, true)
    )
  )
  .limit(1)

if (
  thingCampaignQuery.length === 0 ||
  !thingCampaignQuery[0].thing ||
  !thingCampaignQuery[0].campaign
) {
  return Astro.redirect('/404')
}

const {
  thing: thingData,
  campaign: campaignData,
  thingType: thingTypeData,
} = thingCampaignQuery[0]

// Filter out secret content from description
const filterSecrets = (content: Descendant[] | null): Descendant[] => {
  if (!content) return defaultEditorValue
  return content.filter((node) => !(node as any).isSecret)
}

const publicDescription = filterSecrets(thingData.description as Descendant[])
---

<MainLayout
  title={`${thingData.name} | ${campaignData.name} | ${username} | ArcAide`}
>
  <div class='dnd-content min-h-screen'>
    <div class='mb-4'>
      <a
        href={`/${username}/campaign/${campaignSlug}`}
        class='text-accent text-sm hover:underline'
      >
        ‚Üê Back to {campaignData.name}
      </a>
    </div>

    <h1>{thingData.name}</h1>
    <div class='mb-6'>
      {
        thingTypeData && (
          <p class='text-accent text-sm font-medium'>{thingTypeData.name}</p>
        )
      }
      <p class='text-muted-foreground text-sm'>
        From <a
          href={`/${username}/campaign/${campaignSlug}`}
          class='text-accent hover:underline'
          >{campaignData.name}</a
        >
        by <a
          href={`/${username}`}
          class='text-accent hover:underline'
          >{username}</a
        >
      </p>
    </div>

    <div set:html={slateToHtml(publicDescription, campaignSlug)} />
  </div>
</MainLayout>
